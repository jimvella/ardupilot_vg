(function(){"use strict";const E={0:"MANUAL",1:"CIRCLE",2:"STABILIZE",3:"TRAINING",4:"ACRO",5:"FBWA",6:"FBWB",7:"CRUISE",8:"AUTOTUNE",10:"AUTO",11:"RTL",12:"LOITER",13:"TAKEOFF",14:"AVOID_ADSB",15:"GUIDED",16:"INITIALISING",17:"QSTABILIZE",18:"QHOVER",19:"QLOITER",20:"QLAND",21:"QRTL",22:"QAUTOTUNE",23:"QACRO",24:"THERMAL"},F={0:"STABILIZE",1:"ACRO",2:"ALT_HOLD",3:"AUTO",4:"GUIDED",5:"LOITER",6:"RTL",7:"CIRCLE",9:"LAND",11:"DRIFT",13:"SPORT",14:"FLIP",15:"AUTOTUNE",16:"POSHOLD",17:"BRAKE",18:"THROW",19:"AVOID_ADSB",20:"GUIDED_NOGPS",21:"SMART_RTL",22:"FLOWHOLD",23:"FOLLOW",24:"ZIGZAG",25:"SYSTEMID",26:"AUTOROTATE"},I={0:"MANUAL",1:"ACRO",3:"STEERING",4:"HOLD",5:"LOITER",6:"FOLLOW",7:"SIMPLE",10:"AUTO",11:"RTL",12:"SMART_RTL",15:"GUIDED",16:"INITIALISING"},S={0:"MANUAL",1:"STOP",2:"SCAN",3:"SERVO_TEST",10:"AUTO",16:"INITIALISING"},R={0:"STABILIZE",1:"ACRO",2:"ALT_HOLD",3:"AUTO",4:"GUIDED",7:"CIRCLE",9:"SURFACE",16:"POSHOLD",19:"MANUAL",20:"MOTOR_DETECT"},L={"-":0,"?":1,2:100,1:10,0:1,A:.1,B:.01,C:.001,D:1e-4,E:1e-5,F:1e-6,G:1e-7,"!":3.6,"/":3600},U={1e-6:"n",1e3:"M",.001:"m"},P=163,N=149,D={"-":"","?":"UNKNOWN",A:"A",d:"°",b:"B",k:"°/s",D:"°",e:"°/s/s",E:"rad/s",G:"Gauss",h:"°",i:"A.s",J:"W.s",L:"rad/s/s",m:"m",n:"m/s",o:"m/s/s",O:"°C","%":"%",S:"satellites",s:"s",q:"rpm",r:"rad",U:"°",u:"ppm",v:"V",P:"Pa",w:"Ohm",Y:"us",z:"Hz","#":"instance"};function p(l){let t;return[2,4,13,14,3,15].includes(l)&&(t=F),l===1&&(t=E),l===10&&(t=I),l===5&&(t=S),l===12&&(t=R),t??null}Math.radians=function(l){return l*Math.PI/180},Math.degrees=function(l){return l*180/Math.PI};class y{constructor(t){this.buffer=null,this.data=null,this.FMT=[],this.FMT[128]={Type:"128",length:"89",Name:"FMT",Format:"BBnNZ",Columns:["Type","Length","Name","Format","Columns"]},this.offset=0,this.messages={},this.sent=!1,this.messageTypes={},this.send_postMessage=t??!1}get_type_array(t,e){switch(t){case"a":case"n":case"N":case"Z":return new Array(e);case"b":case"B":case"M":case"h":case"H":case"i":case"L":case"I":case"f":case"d":case"Q":case"q":case"c":case"C":case"E":case"e":return new Float64Array(e)}}parse_type(t){let e;switch(t){case"a":e=[];for(let i=0;i<32;i++)e[i]=this.data.getInt16(this.offset,!0),this.offset+=2;break;case"b":e=this.data.getInt8(this.offset),this.offset+=1;break;case"B":e=this.data.getUint8(this.offset),this.offset+=1;break;case"h":e=this.data.getInt16(this.offset,!0),this.offset+=2;break;case"H":e=this.data.getUint16(this.offset,!0),this.offset+=2;break;case"i":e=this.data.getInt32(this.offset,!0),this.offset+=4;break;case"I":e=this.data.getUint32(this.offset,!0),this.offset+=4;break;case"f":e=this.data.getFloat32(this.offset,!0),this.offset+=4;break;case"d":e=this.data.getFloat64(this.offset,!0),this.offset+=8;break;case"Q":{let i=this.data.getUint32(this.offset,!0);this.offset+=4,e=this.data.getUint32(this.offset,!0)*4294967296+i,i<0&&(e+=4294967296),this.offset+=4;break}case"q":{let i=this.data.getInt32(this.offset,!0);this.offset+=4,e=this.data.getInt32(this.offset,!0)*4294967296+i,i<0&&(e+=4294967296),this.offset+=4;break}case"n":e=String.fromCharCode.apply(null,new Uint8Array(this.buffer,this.offset,4)).replace(/\x00+$/g,""),this.offset+=4;break;case"N":e=String.fromCharCode.apply(null,new Uint8Array(this.buffer,this.offset,16)).replace(/\x00+$/g,""),this.offset+=16;break;case"Z":e=String.fromCharCode.apply(null,new Uint8Array(this.buffer,this.offset,64)).replace(/\x00+$/g,""),this.offset+=64;break;case"c":e=this.data.getInt16(this.offset,!0)/100,this.offset+=2;break;case"C":e=this.data.getUint16(this.offset,!0)/100,this.offset+=2;break;case"E":e=this.data.getUint32(this.offset,!0)/100,this.offset+=4;break;case"e":e=this.data.getInt32(this.offset,!0)/100,this.offset+=4;break;case"L":e=this.data.getInt32(this.offset,!0),this.offset+=4;break;case"M":e=this.data.getUint8(this.offset),this.offset+=1;break}return e}get_size_of(t){switch(t){case"b":case"B":case"M":return 1;case"h":case"H":case"c":case"C":return 2;case"i":case"I":case"f":case"n":case"E":case"e":case"L":return 4;case"d":case"Q":case"q":return 8;case"N":return 16;case"a":case"Z":return 64}}FORMAT_TO_STRUCT(t){const e={};for(let i=0;i<t.Format.length;i++)e[t.Columns[i]]=this.parse_type(t.Format.charAt(i));return e}getFMT(t){for(let e=0;e<this.FMT.length;e++)if(this.FMT[e]!=null&&this.FMT[e].Name==t)return this.FMT[e]}isTypedArray(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}getType(t){return this.isTypedArray(t)&&t.constructor.name}postData(t){t.dataType={};const e=[];for(const i of Object.keys(t.messageList))this.getType(t.messageList[i])&&e.push(t.messageList[i].buffer);self.postMessage(t,e)}get_instance(t,e,i){const s=this.getFMT(t);if(s==null||e&&!("InstancesOffsetArray"in s&&e in s.InstancesOffsetArray))return;const n=c=>{const f=c.length;if(f==0)return;const r=()=>{const u={},h=s.Format.length;for(let o=0;o<h;o++)u[s.Columns[o]]=this.get_type_array(s.Format.charAt(o),f);for(let o=0;o<f;o++){this.offset=c[o];for(let a=0;a<h;a++)u[s.Columns[a]][o]=this.parse_type(s.Format.charAt(a))}return u},g=()=>{const u=s.Columns.indexOf(i);if(u==-1)return;const h=s.FormatOffset[u],o=s.Format.charAt(u),a=this.get_type_array(o,f);for(let T=0;T<f;T++)this.offset=c[T]+h,a[T]=this.parse_type(o);return a};return i?g():r()};return e!=null?n(s.InstancesOffsetArray[e]):n(s.OffsetArray)}get(t,e){return this.get_instance(t,null,e)}parseAtOffset(t){const e=this.getFMT(t);if(e==null)return;const i=(n,c)=>{const f=c.length;if(f==0)return{};const r=n.Format,g=r.length;let u;const h={};for(let o=0;o<g;o++){const a=n.Columns[o];a=="TimeUS"?(u=o,h.time_boot_ms=new Float64Array(f)):h[a]=this.get_type_array(r.charAt(o),f)}for(let o=0;o<f;o++){this.offset=c[o];for(let a=0;a<g;a++)if(a==u)h.time_boot_ms[o]=this.parse_type(r.charAt(a))/1e3;else{const T=n.Columns[a];h[T][o]=this.parse_type(r.charAt(a))}if(this.send_postMessage&&o%1e3===0){const a=100*o/f;self.postMessage({percentage:a})}}return h},s="InstancesOffsetArray"in e;if(console.log(t,s?"has instances":"has no instances"),s){for(const[n,c]of Object.entries(e.InstancesOffsetArray)){const f=t+"["+n+"]";this.messages[f]=i(e,c),this.send_postMessage&&this.postData({messageType:f,messageList:this.messages[f]})}this.send_postMessage&&self.postMessage({percentage:100});return}if(this.messages[t]=i(e,e.OffsetArray),e.Name==="MODE"){const n=this.messages[t].Mode.length;this.messages[t].asText=new Array(n);for(let c=0;c<n;c++)this.messages[t].asText[c]=this.getModeString(this.messages[t].Mode[c])}this.send_postMessage&&(t.indexOf("FMT")===-1&&this.postData({messageType:t,messageList:this.messages[t]}),self.postMessage({percentage:100}))}checkNumberOfInstances(t){if(t.units===void 0)return;const e=t.units.indexOf("instance");if(e==-1)return;const i=t.FormatOffset[e],s=t.Format.charAt(e),n=[];t.InstancesOffsetArray={};const c=t.OffsetArray.length;for(let f=0;f<c;f++){this.offset=t.OffsetArray[f]+i;const r=this.parse_type(s);t.InstancesOffsetArray[r]==null&&(t.InstancesOffsetArray[r]=[],n.push(r)),t.InstancesOffsetArray[r].push(t.OffsetArray[f])}return delete t.OffsetArray,n}DfReader(){let t=0,e=[];for(;this.offset<this.buffer.byteLength-3;){if(this.data.getUint8(this.offset)!==P||this.data.getUint8(this.offset+1)!==N){this.offset+=1;continue}this.offset+=2;const s=this.data.getUint8(this.offset);if(this.offset+=1,e[s]==null&&(e[s]=[]),e[s].push(this.offset),this.FMT[s]!=null)try{if(s===128){const n=this.FORMAT_TO_STRUCT(this.FMT[s]);let c=0,f=new Array(n.Format.length);for(let r=0;r<n.Format.length;r++)f[r]=c,c+=this.get_size_of(n.Format.charAt(r));this.FMT[n.Type]={Type:n.Type,length:n.Length,Name:n.Name,Format:n.Format,Columns:n.Columns.split(","),FormatOffset:f,Size:c}}else this.offset+=this.FMT[s].Size}catch{this.offset+=1}if(this.send_postMessage&&this.offset-t>5e4){const n=100*this.offset/this.buffer.byteLength;self.postMessage({percentage:n}),t=this.offset}}const i=this.FMT.length;for(let s=0;s<i;s++)if(this.FMT[s]!=null){if(e[s]==null){this.FMT[s].Total_Length=0,this.FMT[s].OffsetArray=[];continue}this.FMT[s].OffsetArray=e[s],this.FMT[s].OffsetArray[this.FMT[s].OffsetArray.length-1]+this.FMT[s].Size>this.buffer.byteLength&&this.FMT[s].OffsetArray.pop(),this.FMT[s].Total_Length=this.FMT[s].OffsetArray.length}this.send_postMessage&&(self.postMessage({percentage:100}),self.postMessage({messages:this.messages}),this.sent=!0)}getModeString(t){let e;const i=this.messages.MSG;for(const s in i.Message){if(i.Message[s].toLowerCase().includes("arduplane"))return e=1,p(e)[t];if(i.Message[s].toLowerCase().includes("arducopter"))return e=2,p(e)[t];if(i.Message[s].toLowerCase().includes("ardusub"))return e=12,p(e)[t];if(i.Message[s].toLowerCase().includes("rover"))return e=10,p(e)[t];if(i.Message[s].toLowerCase().includes("tracker"))return e=5,p(e)[t]}return console.log("defaulting to quadcopter"),p(2)[t]}concatTypedArrays(t,e){const i=new t.constructor(t.length+e.length);return i.set(t,0),i.set(e,t.length),i}createUint8ArrayFromString(t){const e=new Uint8Array(t.length);for(let i=0,s=t.length;i<s;i++)e[i]=t.charCodeAt(i);return e}processFiles(){if(this.files={},this.messages.FILE!==void 0){for(const t in this.messages.FILE.FileName){const e=this.messages.FILE.FileName[t],i=this.messages.FILE.Data[t];this.files.hasOwnProperty(e)?this.files[e]=this.concatTypedArrays(this.files[e],this.createUint8ArrayFromString(i)):this.files[e]=this.createUint8ArrayFromString(i)}this.send_postMessage&&self.postMessage({files:this.files})}}populateUnits(){const t=this.get("FMTU");for(const e in t.FmtType){const i=t.FmtType[e];this.FMT[i].units=[];for(const s of t.UnitIds[e])this.FMT[i].units.push(D[s]);this.FMT[i].multipliers=[];for(const s of t.MultIds[e])this.FMT[i].multipliers.push(L[s])}}extractStartTime(){if(!("GPS"in this.messageTypes))return;let t;for(const a of this.FMT){let T=function(m){const d=m+O;(t==null||d<t)&&(t=d)};if(a==null)continue;const _=a.Columns.indexOf("TimeUS");if(_==-1||a.Format.charAt(_)!="Q")continue;const O=a.FormatOffset[_];if("InstancesOffsetArray"in a)for(const m of Object.values(a.InstancesOffsetArray))m.length>0&&T(m[0]);else a.OffsetArray.length>0&&T(a.OffsetArray[0])}let e;t!=null&&(this.offset=t,e=this.parse_type("Q"));function i(a,T,_,O){const d=a.length;for(let A=0;A<d;A++)if(T[A]>=3&&_[A]>1e3&&O[A]>0)return{TimeUS:a[A],weeks:_[A],ms:O[A]}}let s;function n(a){a!=null&&(s==null||a.TimeUS<s.TimeUS)&&(s=a)}if("instances"in this.messageTypes.GPS)for(const a of Object.keys(this.messageTypes.GPS.instances))n(i(this.get_instance("GPS",a,"TimeUS"),this.get_instance("GPS",a,"Status"),this.get_instance("GPS",a,"GWk"),this.get_instance("GPS",a,"GMS")));else n(i(this.get("GPS","TimeUS"),this.get("GPS","Status"),this.get("GPS","GWk"),this.get("GPS","GMS")));if(s==null)return;const c=7*24*60*60*1e3,f=s.weeks*c+s.ms,r=(s.TimeUS-e)*.001,u=315964800*1e3+f-r;let h=new Date(u);const o=this.leapSecondsGPS(h.getUTCFullYear(),h.getUTCMonth()+1);return new Date(h.getTime()-o*1e3)}leapSecondsGPS(t,e){return this.leapSecondsTAI(t,e)-19}leapSecondsTAI(t,e){const i=t*100+e;return i>=201701?37:i>=201507?36:i>=201207?35:i>=200901?34:i>=200601?33:i>=199901?32:i>=199707?31:i>=199601?30:0}processData(t,e){this.buffer=t,this.data=new DataView(this.buffer),this.DfReader();const i={};this.populateUnits();for(const s of this.FMT)if(s&&s.Total_Length!=0){const n=s.Columns,c={};for(let r=0;r<n.length;r++)c[n[r]]={name:n[r],units:s.units?(U[s.multipliers[r]]||"")+s.units[r]:"?",multiplier:s.units?s.multipliers[r]:1};i[s.Name]={expressions:n,units:s.units,multipliers:s.multipliers,complexFields:c};const f=this.checkNumberOfInstances(s);if(f!=null){i[s.Name].instances={};for(const r of f){const g=s.Name+"["+r+"]";i[s.Name].instances[r]=g,i[g]={expressions:n,units:s.units,multipliers:s.multipliers,complexFields:c}}}}this.send_postMessage&&self.postMessage({availableMessages:i}),this.messageTypes=i,e===void 0&&(e=["CMD","MSG","FILE","MODE","AHR2","ATT","GPS","POS","XKQ1","XKQ","NKQ1","NKQ2","XKQ2","PARM","MSG","STAT","EV"]);for(const s of e)this.parseAtOffset(s),s==="FILE"&&this.processFiles();if(this.send_postMessage){const s={startTime:this.extractStartTime()};self.postMessage({metadata:s}),self.postMessage({messagesDoneLoading:!0})}return{types:this.messageTypes,messages:this.messages}}loadType(t){this.parseAtOffset(t),console.log("done")}stats(){let t={};for(const e of this.FMT)if(e){const i=e.Size+3,s=e.Total_Length,n=i*s;t[e.Name]={count:s,msg_size:i,size:n}}return t}}self.addEventListener("message",function(l){let t;if(l.data===null)console.log("got bad file message!");else if(l.data.action==="parse"){t=new y;const e=l.data.file;t.processData(e)}else l.data.action==="loadType"?t.loadType(l.data.type.split("[")[0]):l.data.action==="trimFile"&&t.trimFile(l.data.time)});let M;self.addEventListener("message",function(l){if(l.data===null)console.log("got bad file message!");else if(l.data.action==="parse"){const t=l.data.file;M=new y(!0),M.processData(t,["CMD","MSG","FILE","MODE","AHR2","ATT","GPS","POS","XKQ1","XKQ","NKQ1","NKQ2","XKQ2","PARM","MSG","STAT","EV","BARO","HYGR","IMU","XKF1","XKF2","XKF3","XKF4"])}else l.data.action==="loadType"&&(M||console.log("parser not ready"),M.loadType(l.data.type.split("[")[0]))})})();
